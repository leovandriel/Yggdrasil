# Convert country codes from FIPS 10-4 to ISO 3166-1.
#
# License: BSD
# Author:  Leonard van Driel, 2013

require 'json'
require 'set'
require 'stringio'

string = STDIN.read
warn "err: no input from stdin" or exit if string.empty?

lookup = JSON.parse DATA.read
warn "err: unable to parse lookup" or exit if lookup.empty?

buffer = StringIO.new
not_found = [].to_set

index = -1 and last = -3
loop do
  index = string.index(/[^A-Za-z0-9][A-Z][A-Z][^A-Za-z0-9]/, index + 1)
  unless index
    buffer << string[last+3..-1] if not_found.empty?
    break
  end
  fips = string[index+1..index+2]
  iso = lookup[fips]
  not_found << fips unless iso
  if not_found.empty?
    buffer << string[last+3..index]
    buffer << iso
  end
  last = index
end

warn "err: no iso for fips codes #{not_found.sort.join(', ')}" or exit unless not_found.empty?

print buffer.string

__END__
{
"AA":"AW",
"AC":"AG",
"AE":"AE",
"AF":"AF",
"AG":"DZ",
"AJ":"AZ",
"AL":"AL",
"AM":"AM",
"AN":"AD",
"AO":"AO",
"AQ":"AS",
"AR":"AR",
"AS":"AU",
"AT":"AU",
"AU":"AT",
"AV":"AI",
"AY":"AQ",
"BA":"BH",
"BB":"BB",
"BC":"BW",
"BD":"BM",
"BE":"BE",
"BF":"BS",
"BG":"BD",
"BH":"BZ",
"BK":"BA",
"BL":"BO",
"BM":"MM",
"BN":"BJ",
"BO":"BY",
"BP":"SB",
"BQ":"UM",
"BR":"BR",
"BS":"TF",
"BT":"BT",
"BU":"BG",
"BV":"BV",
"BX":"BN",
"BY":"BI",
"CA":"CA",
"CB":"KH",
"CD":"TD",
"CE":"LK",
"CF":"CG",
"CG":"CD",
"CH":"CN",
"CI":"CL",
"CJ":"KY",
"CK":"CC",
"CM":"CM",
"CN":"KM",
"CO":"CO",
"CQ":"MP",
"CR":"AU",
"CS":"CR",
"CT":"CF",
"CU":"CU",
"CV":"CV",
"CW":"CK",
"CY":"CY",
"DA":"DK",
"DJ":"DJ",
"DO":"DM",
"DQ":"UM",
"DR":"DO",
"EC":"EC",
"EG":"EG",
"EI":"IE",
"EK":"GQ",
"EN":"EE",
"ER":"ER",
"ES":"SV",
"ET":"ET",
"EU":"TF",
"EZ":"CZ",
"FG":"GF",
"FI":"FI",
"FJ":"FJ",
"FK":"FK",
"FM":"FM",
"FO":"FO",
"FP":"PF",
"FQ":"UM",
"FR":"FR",
"FS":"TF",
"GA":"GM",
"GB":"GA",
"GG":"GE",
"GH":"GH",
"GI":"GI",
"GJ":"GD",
"GK":"GG",
"GL":"GL",
"GM":"DE",
"GO":"TF",
"GP":"GP",
"GQ":"GU",
"GR":"GR",
"GT":"GT",
"GV":"GN",
"GY":"GY",
"GZ":"PS",
"HA":"HT",
"HK":"HK",
"HM":"HM",
"HO":"HN",
"HQ":"UM",
"HR":"HR",
"HU":"HU",
"IC":"IS",
"ID":"ID",
"IM":"IM",
"IN":"IN",
"IO":"IO",
"IP":"FR",
"IR":"IR",
"IS":"IL",
"IT":"IT",
"IV":"CI",
"IZ":"IQ",
"JA":"JP",
"JE":"JE",
"JM":"JM",
"JN":"SJ",
"JO":"JO",
"JQ":"UM",
"JU":"TF",
"KE":"KE",
"KG":"KG",
"KN":"KP",
"KQ":"UM",
"KR":"KI",
"KS":"KR",
"KT":"CX",
"KU":"KW",
"KZ":"KZ",
"LA":"LA",
"LE":"LB",
"LG":"LV",
"LH":"LT",
"LI":"LR",
"LO":"SK",
"LQ":"UM",
"LS":"LI",
"LT":"LS",
"LU":"LU",
"LY":"LY",
"MA":"MG",
"MB":"MQ",
"MC":"MO",
"MD":"MD",
"MF":"YT",
"MG":"MN",
"MH":"MS",
"MI":"MW",
"MJ":"ME",
"MK":"MK",
"ML":"ML",
"MN":"MC",
"MO":"MA",
"MP":"MU",
"MQ":"UM",
"MR":"MR",
"MT":"MT",
"MU":"OM",
"MV":"MV",
"MW":"ME",
"MX":"MX",
"MY":"MY",
"MZ":"MZ",
"NC":"NC",
"NE":"NU",
"NF":"NF",
"NG":"NE",
"NH":"VU",
"NI":"NG",
"NL":"NL",
"NN":"SX",
"NO":"NO",
"NP":"NP",
"NR":"NR",
"NS":"SR",
"NT":"NT",
"NU":"NI",
"NZ":"NZ",
"PA":"PY",
"PC":"PN",
"PE":"PE",
"PF":"PI",
"PG":"RP",
"PK":"PK",
"PL":"PL",
"PM":"PA",
"PO":"PT",
"PP":"PG",
"PS":"PW",
"PU":"GW",
"QA":"QA",
"RE":"RE",
"RI":"RS",
"RM":"MH",
"RN":"MF",
"RO":"RO",
"RP":"PH",
"RQ":"PR",
"RS":"RU",
"RW":"RW",
"SA":"SA",
"SB":"PM",
"SC":"KN",
"SE":"SC",
"SF":"ZA",
"SG":"SN",
"SH":"SH",
"SI":"SI",
"SL":"SL",
"SM":"SM",
"SN":"SG",
"SO":"SO",
"SP":"ES",
"SR":"SR",
"ST":"LC",
"SU":"SD",
"SV":"SJ",
"SW":"SE",
"SX":"GS",
"SY":"SY",
"SZ":"CH",
"TB":"BL",
"TC":"TC",
"TD":"TT",
"TE":"TF",
"TH":"TH",
"TI":"TJ",
"TK":"TC",
"TL":"TK",
"TN":"TO",
"TO":"TG",
"TP":"ST",
"TS":"TN",
"TT":"TL",
"TU":"TR",
"TV":"TV",
"TW":"TW",
"TX":"TM",
"TZ":"TZ",
"UC":"CW",
"UG":"UG",
"UK":"GB",
"UP":"UA",
"US":"US",
"UV":"BF",
"UY":"UY",
"UZ":"UZ",
"VC":"VC",
"VE":"VE",
"VI":"VG",
"VM":"VN",
"VQ":"VI",
"VT":"VA",
"WA":"NA",
"WE":"PS",
"WF":"WF",
"WI":"EH",
"WQ":"UM",
"WS":"WS",
"WZ":"SZ",
"YM":"YE",
"ZA":"ZM",
"ZI":"ZW"
}
